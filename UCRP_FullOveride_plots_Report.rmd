---
title: "UCRP Full Override Model"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(knitr)
library(data.table)
library(gdata) # read.xls
library(plyr)
library(dplyr)
options(dplyr.print_min = 100) # default is 10
options(dplyr.print_max = 100) # default is 20
library(ggplot2)
library(gridExtra)
library(magrittr)
library(tidyr) # gather, spread
library(foreach)
library(doParallel)
library(microbenchmark)
library(readxl)
library(stringr)
library("readxl")
library("XLConnect") # slow but convenient because it reads ranges; NOTE: I had to install Java 64-bit on Windows 10 64-bit to load properly
library(xlsx)
library("btools")

source("Functions.R")
```


```{r, echo = FALSE, include=F}
# folderName <- "FullOverride/Results/"
# load_lresults <- function(runname){
#   fn <- paste0(folderName, "lresults_", runname, ".RData")
#   load(fn, envir = globalenv())}

load_multiFiles <- function(fileList){
  sapply(fileList, load, envir = globalenv())
}

get_lineplot <- function(df, x, y){
    ggplot(df, aes_string(x = x, y = y)) + theme_bw() + 
    geom_line() + geom_point() + 
    scale_x_continuous(breaks = seq(2015, 2045, 5))
}

  
```


```{r, echo=FALSE}
# Load results

folderName <- "FullOverride/Results/"

runnames <- paste0(paste0("RS", 1:5), rep(c(".Cap", ".noCap", ".ADC"), each = 5))

files_lresults <- paste0("lresults_", runnames, ".RData")
files_lContVol <- paste0("lContVol_", runnames, ".RData")

load_multiFiles(paste0(folderName, files_lresults))
load_multiFiles(paste0(folderName, files_lContVol))

Outputs_folder <- "FullOverride/Report_graphs/"



```



```{r, echo = FALSE, fig.width= 12}

g1 <- lresults_RS1.Cap$g.distReturn

g1

g.height <- 5.5
g.width <- 9

ggsave(file = paste0(Outputs_folder, "DistReturn.png"), g1, height = g.height, width = g.width)

```




# Illustration of individual stochastic simulation

```{r, echo = FALSE, fig.width= 12}

g1 <- lresults_RS1.Cap$g.ind.annualReturn
g2 <- lresults_RS1.Cap$g.ind.expandgeoReturn
g3 <- lresults_RS1.Cap$g.ind.FR
g4 <- lresults_RS1.Cap$g.ind.ERCwSTIP

g1
g2
g3
g4

g.height <- 5.5
g.width <- 11

ggsave(file = paste0(Outputs_folder, "indivRuns.annualReturn.png"), g1, height = g.height, width = g.width)
ggsave(file = paste0(Outputs_folder, "indivRuns.rollingReturn.png"), g2, height = g.height, width = g.width)
ggsave(file = paste0(Outputs_folder, "indivRuns.FRpath.png"), g3, height = g.height, width = g.width)
ggsave(file = paste0(Outputs_folder, "indivRuns.ERCpath.png"), g4, height = g.height, width = g.width)


```



# Summary of stochastic results

```{r, echo = FALSE, fig.width= 12}


# Funded ratio 
#g1 <- lresults_RS1.Cap$g.stch.FR40

lContVol_RS1.Cap$prob_FR40less.rolling

g1 <- 
lresults_RS1.Cap$tbl.riskMeasure %>% select(year, FR40less) %>% 
  mutate(FR40less.det = 0) %>% 
  gather(variable, value, - year) %>% 
  ggplot(aes(x = year, y = value, color = variable)) + theme_bw() + 
  geom_point() + geom_line() + 
  coord_cartesian(ylim = c(0,20)) + 
  scale_y_continuous(breaks = seq(0,200, 5)) +
  scale_color_manual(values = c("red","black"),  name = "", 
                     label  = c("Stochastic run", "Deterministic run")) + 
  labs(title = "Probability of funded ratio below 40% \nin a given year",
       x = NULL, y = "Probability (%)")


g1.1 <- 
lContVol_RS1.Cap$prob_FR40less.rolling %>% select(year, FR40less) %>% 
  mutate(FR40less.det = 0) %>% 
  gather(variable, value, - year) %>% 
  ggplot(aes(x = year, y = value, color = variable)) + theme_bw() + 
  geom_point() + geom_line() + 
  coord_cartesian(ylim = c(0,20)) + 
  scale_y_continuous(breaks = seq(0,200, 5)) +
  scale_color_manual(values = c("red","black"),  name = "", 
                     label  = c("Stochastic run", "Deterministic run")) + 
  labs(title = "Probability of funded ratio below 40% \nat any time prior to and including the given year",
       x = NULL, y = "Probability (%)")
g1.1
lContVol_RS1.Cap$prob_FR40less.rolling



# Contribution
lContVol_RS1.Cap$prob_highERC
lContVol_RS1.Cap$prob_ERCsharpRisePts.rolling

g2 <- lContVol_RS1.Cap$prob_ERCsharpRisePts.rolling %>% 
  get_lineplot("year", "Chg10Pts5y2") + 
  coord_cartesian(ylim = c(0,40)) + 
  scale_y_continuous(breaks = seq(0,200, 5)) +
  labs(title = "Probability of employer contribution rising more than 10% of payroll \nin a 5-year period at any time prior to and including the given year",
       x = NULL, y = "Probability(%)")


g3 <- lContVol_RS1.Cap$prob_ERCsharpRisePts.rolling %>% 
  get_lineplot("year", "Chg6Pts5y2") + 
  coord_cartesian(ylim = c(0,40)) + 
  scale_y_continuous(breaks = seq(0,200, 5)) +
  labs(title = "Probability of employer contribution rising more than 6% of payroll \nin a 5-year period at any time prior to and including the given year",
       x = NULL, y = "Probability(%)")




g1
g2


hw.ratio <- 7/9

g.width  <- 7
g.height <- g.width*hw.ratio 

ggsave(file = paste0(Outputs_folder, "sumStchResults.FR40.png"), g1, height = g.height, width = g.width)
ggsave(file = paste0(Outputs_folder, "sumStchResults.FR40.rolling.png"), g1.1, height = g.height, width = g.width)
ggsave(file = paste0(Outputs_folder, "sumStchResults.ERCIncrease.png"), g2, height = g.height, width = g.width)
ggsave(file = paste0(Outputs_folder, "sumStchResults.ERCIncrease6pts.png"), g3, height = g.height, width = g.width)

```


# Comparison of funding policies

```{r, echo = FALSE, fig.width= 12}


# Funded ratio 
tbl.comparePolicies <- bind_rows(
  lresults_RS1.Cap$tbl.riskMeasure,
  lresults_RS1.noCap$tbl.riskMeasure,
  lresults_RS1.ADC$tbl.riskMeasure
)
tbl.comparePolicies

# Graph for prob that FR falls below 40%

g1 <- tbl.comparePolicies %>% 
  ggplot(aes(x = year, y = FR40less, color = factor(runname, levels = c("RS1.Cap", "RS1.noCap", "RS1.ADC")))) + theme_bw() + 
  geom_line() + geom_point() +
  scale_x_continuous(breaks = seq(2015, 2045, 5)) + 
  scale_color_manual(values = c("red","green", "darkblue"),  name = "Contribution \nPolicies", 
                     label  = c("w/ Cap", "w/o Cap", "ADC")) + 
  labs(title = "Probability of funded ratio below 40% in a given year \n under different funding policies",
       x = NULL, y = "Probability (%)")

# Graph for distribution of funded ratio
g2 <- tbl.comparePolicies %>%
  mutate(runname = factor(runname, levels = c("RS1.Cap", "RS1.noCap", "RS1.ADC"), labels = c("with Cap", "without Cap", "ADC"))) %>% 
  select(runname, year, FR.q25, FR.med, FR.q75) %>% 
  gather(type, value, -runname, -year) %>% 
  ggplot(aes(x = year, y = value,
             color = factor(type, levels = c("FR.q25", "FR.med", "FR.q75"))
             )) + theme_bw() + facet_grid(.~runname) + 
  geom_line() + geom_point() +
  scale_x_continuous(breaks = seq(2015, 2045, 10)) + 
  scale_color_manual(values = c("red","green", "darkblue"),  name = "Contribution \nPolicies", 
                     label  = c("25th percentile", "median", "75th percentile")) + 
  labs(title = "Distribution of funded ratio across simulations under different funding policies",
       x = NULL, y = "Percent")

tbl.comparePolicies


# Employer contribution

tbl.comparePolicies_highERC <- bind_rows(
  lContVol_RS1.Cap$prob_highERC,
  lContVol_RS1.noCap$prob_highERC,
  lContVol_RS1.ADC$prob_highERC
)
tbl.comparePolicies_highERC

tbl.comparePolicies_ERCincrease <- bind_rows(
  lContVol_RS1.Cap$prob_ERCsharpRisePts.rolling,
  lContVol_RS1.noCap$prob_ERCsharpRisePts.rolling,
  lContVol_RS1.ADC$prob_ERCsharpRisePts.rolling
)

tbl.comparePolicies_FR40rolling <- bind_rows(
  lContVol_RS1.Cap$prob_FR40less.rolling,
  lContVol_RS1.noCap$prob_FR40less.rolling,
  lContVol_RS1.ADC$prob_FR40less.rolling
)


g1.1 <- tbl.comparePolicies_FR40rolling %>% 
  ggplot(aes(x = year, y = FR40less, color = factor(runname, levels = c("RS1.Cap", "RS1.noCap", "RS1.ADC")))) + theme_bw() + 
  geom_line() + geom_point() +
  scale_x_continuous(breaks = seq(2015, 2045, 5)) + 
  scale_color_manual(values = c("red","green", "darkblue"),  name = "Contribution \nPolicies", 
                     label  = c("w/ Cap", "w/o Cap", "ADC")) + 
  labs(title = "Probability of funded ratio below 40% \nat any time prior to and including the given year \nunder different funding policies",
       x = NULL, y = "Probability (%)")
g1.1

tbl.comparePolicies_FR40rolling

# Graph for risk of high ERC

g3 <- tbl.comparePolicies_highERC %>% 
  ggplot(aes(x = year, y = ERC_PR30, color = factor(runname, levels = c("RS1.Cap", "RS1.noCap", "RS1.ADC")))) + theme_bw() + 
  geom_line() + geom_point() +
  scale_x_continuous(breaks = seq(2015, 2045, 5)) + 
  scale_color_manual(values = c("red","green", "darkblue"),  name = "Contribution \nPolicies", 
                     label  = c("w/ Cap", "w/o Cap", "ADC")) + 
  labs(title = "Probability of ERC above 30% of payroll \nat any time prior to and including the given year \nunder different funding policies",
       x = NULL, y = "Probability (%)")


g4 <- tbl.comparePolicies_ERCincrease %>% 
  ggplot(aes(x = year, y = Chg10Pts5y2, color = factor(runname, levels = c("RS1.Cap", "RS1.noCap", "RS1.ADC")))) + theme_bw() + 
  geom_line() + geom_point() +
  scale_x_continuous(breaks = seq(2015, 2045, 5)) + 
  scale_color_manual(values = c("red","green", "darkblue"),  name = "Contribution \nPolicies", 
                     label  = c("w/ Cap", "w/o Cap", "ADC")) + 
  labs(title = "Probability of ERC rising by more than 10% of payroll \nat any time prior to and including the given year \nunder different funding policies",
       x = NULL, y = "Probability (%)")


# Graph for distribution of ERC rate with STIP
g5 <- tbl.comparePolicies %>%
  mutate(runname = factor(runname, levels = c("RS1.Cap", "RS1.noCap", "RS1.ADC"), labels = c("with Cap", "without Cap", "ADC"))) %>% 
  select(runname, year, ERCwSTIP_PR.q25, ERCwSTIP_PR.med, ERCwSTIP_PR.q75) %>% 
  gather(type, value, -runname, -year) %>% 
  ggplot(aes(x = year, y = value,
             color = factor(type, levels = c("ERCwSTIP_PR.q25", "ERCwSTIP_PR.med", "ERCwSTIP_PR.q75"))
             )) + theme_bw() + facet_grid(.~runname) + 
  geom_line() + geom_point() +
  scale_x_continuous(breaks = seq(2015, 2045, 10)) + 
  scale_color_manual(values = c("red","green", "darkblue"),  name = "Contribution \nPolicies", 
                     label  = c("25th percentile", "median", "75th percentile")) + 
  labs(title = "Distribution of employer contribution across simulations under different funding policies",
       x = NULL, y = "Percent")

tbl.comparePolicies

g3
g4
g5

hw.ratio <- 7/9

g.width  <- 7
g.height <- g.width*hw.ratio 

ggsave(file = paste0(Outputs_folder, "ComparePolicies.FR40.png"), g1, height = g.height, width = g.width)
ggsave(file = paste0(Outputs_folder, "ComparePolicies.FR40.rolling.png"), g1.1, height = g.height, width = g.width)
ggsave(file = paste0(Outputs_folder, "ComparePolicies.FR_dist.png"), g2, height = 4, width = 10)

ggsave(file = paste0(Outputs_folder, "ComparePolicies.higERC.png"), g3, height = g.height, width = g.width)
ggsave(file = paste0(Outputs_folder, "ComparePolicies.ERCIncrease.png"), g4, height = g.height, width = g.width)
ggsave(file = paste0(Outputs_folder, "ComparePolicies.ERC_dist.png"), g5, height = 4, width = 10)

```



# Comparison of return scenarios

```{r, echo = FALSE, fig.width= 12}

# Funded ratio 
tbl.compareRS <- bind_rows(
  lresults_RS1.Cap$tbl.riskMeasure,
  lresults_RS2.Cap$tbl.riskMeasure,
  lresults_RS3.Cap$tbl.riskMeasure,
  
  lresults_RS1.noCap$tbl.riskMeasure,
  lresults_RS2.noCap$tbl.riskMeasure,
  lresults_RS3.noCap$tbl.riskMeasure,
  
  lresults_RS1.ADC$tbl.riskMeasure,
  lresults_RS2.ADC$tbl.riskMeasure,
  lresults_RS3.ADC$tbl.riskMeasure
) %>% 
  mutate(RS = str_sub(runname, 1,3),
         policy = str_sub(runname, 5),
         policy = factor(policy, levels = c("Cap", "noCap", "ADC"), labels = c("with Cap", "without Cap", "ADC")))

tbl.compareRS_highERC <- bind_rows(
  lContVol_RS1.Cap$prob_highERC,
  lContVol_RS2.Cap$prob_highERC,
  lContVol_RS3.Cap$prob_highERC,
  
  lContVol_RS1.noCap$prob_highERC,
  lContVol_RS2.noCap$prob_highERC,
  lContVol_RS3.noCap$prob_highERC,
  
  lContVol_RS1.ADC$prob_highERC,
  lContVol_RS2.ADC$prob_highERC,
  lContVol_RS3.ADC$prob_highERC
  )%>% 
  mutate(RS = str_sub(runname, 1,3),
         policy = str_sub(runname, 5),
         policy = factor(policy, levels = c("Cap", "noCap", "ADC"), labels = c("with Cap", "without Cap", "ADC")))

tbl.compareRS_ERCincrease <- bind_rows(
  lContVol_RS1.Cap$prob_ERCsharpRisePts.rolling,
  lContVol_RS2.Cap$prob_ERCsharpRisePts.rolling,
  lContVol_RS3.Cap$prob_ERCsharpRisePts.rolling,
  
  lContVol_RS1.noCap$prob_ERCsharpRisePts.rolling,
  lContVol_RS2.noCap$prob_ERCsharpRisePts.rolling,
  lContVol_RS3.noCap$prob_ERCsharpRisePts.rolling,
  
  lContVol_RS1.ADC$prob_ERCsharpRisePts.rolling,
  lContVol_RS2.ADC$prob_ERCsharpRisePts.rolling,
  lContVol_RS3.ADC$prob_ERCsharpRisePts.rolling
)%>% 
  mutate(RS = str_sub(runname, 1,3),
         policy = str_sub(runname, 5),
         policy = factor(policy, levels = c("Cap", "noCap", "ADC"), labels = c("with Cap", "without Cap", "ADC")))


tbl.compareRS_FR40rolling <- bind_rows(
  lContVol_RS1.Cap$prob_FR40less.rolling,
  lContVol_RS2.Cap$prob_FR40less.rolling,
  lContVol_RS3.Cap$prob_FR40less.rolling,
  
  lContVol_RS1.noCap$prob_FR40less.rolling,
  lContVol_RS2.noCap$prob_FR40less.rolling,
  lContVol_RS3.noCap$prob_FR40less.rolling,
  
  lContVol_RS1.ADC$prob_FR40less.rolling,
  lContVol_RS2.ADC$prob_FR40less.rolling,
  lContVol_RS3.ADC$prob_FR40less.rolling
  )%>% 
  mutate(RS = str_sub(runname, 1,3),
         policy = str_sub(runname, 5),
         policy = factor(policy, levels = c("Cap", "noCap", "ADC"), labels = c("with Cap", "without Cap", "ADC")))



# Funded ratio Below 40%

g1 <- tbl.compareRS %>% 
  ggplot(aes(x = year, y = FR40less, color = factor(RS, levels = paste0("RS", 1:3)))) + theme_bw() + 
  geom_line() + geom_point() + facet_grid(. ~ policy) + 
  scale_x_continuous(breaks = seq(2015, 2045, 5)) + 
  scale_color_manual(values = c("red","green", "blue2"),  name = "",   #"Return \nScenarios",
                     label  = c("Scenario1: \n7.25% compound return", "Scenario2: \n6.9% compound return", "Scenario3: \n6.36% compound return")) +
  labs(title = "Probability of funded ratio below 40% \nat any time prior to and including the given year \n under different return scenarios", x = NULL, y = "Probability (%)") +
  theme(axis.text.x = element_text(size = 7), legend.position="bottom") +
  guides(color = guide_legend(keywidth = 3, keyheight = 1))

g1

g1.1 <- tbl.compareRS_FR40rolling %>% 
  ggplot(aes(x = year, y = FR40less, color = factor(RS, levels = paste0("RS", 1:3)))) + theme_bw() + 
  geom_line() + geom_point() + facet_grid(. ~ policy) + 
  scale_x_continuous(breaks = seq(2015, 2045, 5)) + 
  scale_color_manual(values = c("red","green", "blue2"),  name = "",   #"Return \nScenarios",
                     label  = c("Scenario1: \n7.25% compound return", "Scenario2: \n6.9% compound return", "Scenario3: \n6.36% compound return")) +
  labs(title = "Probability of funded ratio below 40% \nat any time prior to and including the given year \nunder different return scenarios", x = NULL, y = "Probability (%)") +
  theme(axis.text.x = element_text(size = 7), legend.position="bottom") +
  guides(color = guide_legend(keywidth = 3, keyheight = 1))

g1.1


# Prob of high ERC
g2 <- tbl.compareRS_highERC %>% 
  ggplot(aes(x = year, y = ERC_PR30, color = factor(RS, levels = paste0("RS", 1:3)))) + theme_bw() + 
  geom_line() + geom_point() + facet_grid(. ~ policy) +
  scale_x_continuous(breaks = seq(2015, 2045, 5)) + 
  scale_color_manual(values = c("red","green", "blue2"),  name = "",   #"Return \nScenarios",
                     label  = c("Scenario1: \n7.25% compound return", "Scenario2: \n6.9% compound return", "Scenario3: \n6.36% compound return")) +
  labs(title = "Probability of ERC above 30% of payroll \nat any time prior to and including the given year \n under different return scenarios", x = NULL, y = "Probability (%)") +
  theme(axis.text.x = element_text(size = 7), legend.position="bottom") +
  guides(color = guide_legend(keywidth = 3, keyheight = 1)) 
g2


# Prob of sharp ERC increases
g3 <- tbl.compareRS_ERCincrease %>% 
  ggplot(aes(x = year, y = Chg10Pts5y2, color = factor(RS, levels = paste0("RS", 1:3)))) + theme_bw() + 
  geom_line() + geom_point() + facet_grid(. ~ policy) +
  scale_x_continuous(breaks = seq(2015, 2045, 5)) + 
  scale_color_manual(values = c("red","green", "blue2"),  name = "",   #"Return \nScenarios",
                     label  = c("Scenario1: \n7.25% compound return", "Scenario2: \n6.9% compound return", "Scenario3: \n6.36% compound return")) +
  labs(title = "Probability of ERC rising by more than 10% of payroll \nat any time prior to and including the given year \nunder different return scenarios", x = NULL, y = "Probability (%)") +
  theme(axis.text.x = element_text(size = 7), legend.position="bottom") +
  guides(color = guide_legend(keywidth = 3, keyheight = 1)) 
g3



ggsave(file = paste0(Outputs_folder, "CompareRS.FR40.png"), g1, height = 5, width = 10)
ggsave(file = paste0(Outputs_folder, "CompareRS.FR40.rolling.png"), g1.1, height = 5, width = 10)
ggsave(file = paste0(Outputs_folder, "CompareRS.higERC.png"), g2, height = 5, width = 10)
ggsave(file = paste0(Outputs_folder, "CompareRS.ERCIncrease.png"), g3, height = 5, width = 10)



# Tables for comparing return scenarios 

tbl.compareRS_report1 <- tbl.compareRS %>% 
  select(runname, year, FR40less) %>% 
  filter(year %in% c(seq(2015, 2040, 5), 2044)) %>% 
  spread(runname, FR40less)
tbl.compareRS_report1


tbl.compareRS_highERC.report1 <- tbl.compareRS_highERC %>% 
  select(runname, year, ERC_PR30) %>% 
  filter(year %in% c(seq(2015, 2040, 5), 2044)) %>% 
  spread(runname, ERC_PR30)
tbl.compareRS_highERC.report1


tbl.compareRS_ERCincrease.report1 <- tbl.compareRS_ERCincrease %>% 
  select(runname, year, Chg10Pts5y2) %>% 
  filter(year %in% c(seq(2015, 2040, 5), 2044)) %>% 
  spread(runname, Chg10Pts5y2)
tbl.compareRS_ERCincrease.report1

tbl.compareRS_FR40rolling.report1 <- tbl.compareRS_FR40rolling %>% 
  select(runname, year, FR40less) %>% 
  filter(year %in% c(seq(2015, 2040, 5), 2044)) %>% 
  spread(runname, FR40less)
tbl.compareRS_FR40rolling.report1



paste0(Outputs_folder, "CompareRS.FR40.png")

write.xlsx2(tbl.compareRS_report1, paste0(Outputs_folder, "RS_tbl.xlsx"), sheetName = "FR")
write.xlsx2(tbl.compareRS_FR40rolling.report1, paste0(Outputs_folder, "RS_tbl.xlsx"), sheetName = "FR.rolling", append = TRUE)
write.xlsx2(tbl.compareRS_highERC.report1, paste0(Outputs_folder, "RS_tbl.xlsx"), sheetName = "highERC", append = TRUE)
write.xlsx2(tbl.compareRS_ERCincrease.report1, paste0(Outputs_folder, "RS_tbl.xlsx"), sheetName = "ERCincrease", append = TRUE)


```


# Comparison of return scenarios

```{r, echo = FALSE, fig.width= 12}

# Funded ratio 
tbl.compareRS <- bind_rows(
  lresults_RS1.Cap$tbl.riskMeasure,
  lresults_RS2.Cap$tbl.riskMeasure,
  lresults_RS3.Cap$tbl.riskMeasure,
  lresults_RS4.Cap$tbl.riskMeasure,
  lresults_RS5.Cap$tbl.riskMeasure,
  
  lresults_RS1.noCap$tbl.riskMeasure,
  lresults_RS2.noCap$tbl.riskMeasure,
  lresults_RS3.noCap$tbl.riskMeasure,
  lresults_RS4.noCap$tbl.riskMeasure,
  lresults_RS5.noCap$tbl.riskMeasure,
  
  lresults_RS1.ADC$tbl.riskMeasure,
  lresults_RS2.ADC$tbl.riskMeasure,
  lresults_RS3.ADC$tbl.riskMeasure,
  lresults_RS4.ADC$tbl.riskMeasure,
  lresults_RS5.ADC$tbl.riskMeasure
  
) %>% 
  mutate(RS = str_sub(runname, 1,3),
         policy = str_sub(runname, 5),
         policy = factor(policy, levels = c("Cap", "noCap", "ADC"), labels = c("with Cap", "without Cap", "ADC")))

tbl.compareRS_highERC <- bind_rows(
  lContVol_RS1.Cap$prob_highERC,
  lContVol_RS2.Cap$prob_highERC,
  lContVol_RS3.Cap$prob_highERC,
  lContVol_RS4.Cap$prob_highERC,
  lContVol_RS5.Cap$prob_highERC,
  
  lContVol_RS1.noCap$prob_highERC,
  lContVol_RS2.noCap$prob_highERC,
  lContVol_RS3.noCap$prob_highERC,
  lContVol_RS4.noCap$prob_highERC,
  lContVol_RS5.noCap$prob_highERC,
  
  lContVol_RS1.ADC$prob_highERC,
  lContVol_RS2.ADC$prob_highERC,
  lContVol_RS3.ADC$prob_highERC,
  lContVol_RS4.ADC$prob_highERC,
  lContVol_RS5.ADC$prob_highERC
  )%>% 
  mutate(RS = str_sub(runname, 1,3),
         policy = str_sub(runname, 5),
         policy = factor(policy, levels = c("Cap", "noCap", "ADC"), labels = c("with Cap", "without Cap", "ADC")))

tbl.compareRS_ERCincrease <- bind_rows(
  lContVol_RS1.Cap$prob_ERCsharpRisePts.rolling,
  lContVol_RS2.Cap$prob_ERCsharpRisePts.rolling,
  lContVol_RS3.Cap$prob_ERCsharpRisePts.rolling,
  lContVol_RS4.Cap$prob_ERCsharpRisePts.rolling,
  lContVol_RS5.Cap$prob_ERCsharpRisePts.rolling,
  
  lContVol_RS1.noCap$prob_ERCsharpRisePts.rolling,
  lContVol_RS2.noCap$prob_ERCsharpRisePts.rolling,
  lContVol_RS3.noCap$prob_ERCsharpRisePts.rolling,
  lContVol_RS4.noCap$prob_ERCsharpRisePts.rolling,
  lContVol_RS5.noCap$prob_ERCsharpRisePts.rolling,
  
  lContVol_RS1.ADC$prob_ERCsharpRisePts.rolling,
  lContVol_RS2.ADC$prob_ERCsharpRisePts.rolling,
  lContVol_RS3.ADC$prob_ERCsharpRisePts.rolling,
  lContVol_RS4.ADC$prob_ERCsharpRisePts.rolling,
  lContVol_RS5.ADC$prob_ERCsharpRisePts.rolling
)%>% 
  mutate(RS = str_sub(runname, 1,3),
         policy = str_sub(runname, 5),
         policy = factor(policy, levels = c("Cap", "noCap", "ADC"), labels = c("with Cap", "without Cap", "ADC")))


tbl.compareRS_FR40rolling <- bind_rows(
  lContVol_RS1.Cap$prob_FR40less.rolling,
  lContVol_RS2.Cap$prob_FR40less.rolling,
  lContVol_RS3.Cap$prob_FR40less.rolling,
  lContVol_RS4.Cap$prob_FR40less.rolling,
  lContVol_RS5.Cap$prob_FR40less.rolling,
  
  lContVol_RS1.noCap$prob_FR40less.rolling,
  lContVol_RS2.noCap$prob_FR40less.rolling,
  lContVol_RS3.noCap$prob_FR40less.rolling,
  lContVol_RS4.noCap$prob_FR40less.rolling,
  lContVol_RS5.noCap$prob_FR40less.rolling,
  
  lContVol_RS1.ADC$prob_FR40less.rolling,
  lContVol_RS2.ADC$prob_FR40less.rolling,
  lContVol_RS3.ADC$prob_FR40less.rolling,
  lContVol_RS4.ADC$prob_FR40less.rolling,
  lContVol_RS5.ADC$prob_FR40less.rolling
  )%>% 
  mutate(RS = str_sub(runname, 1,3),
         policy = str_sub(runname, 5),
         policy = factor(policy, levels = c("Cap", "noCap", "ADC"), labels = c("with Cap", "without Cap", "ADC")))





# Funded ratio Below 40%

g1 <- tbl.compareRS %>% 
  ggplot(aes(x = year, y = FR40less, color = factor(RS, levels = paste0("RS", 1:5)))) + theme_bw() + 
  geom_line() + geom_point() + facet_grid(. ~ policy) + 
  scale_x_continuous(breaks = seq(2015, 2045, 5)) + 
  scale_color_manual(values = c("red","green", "blue2", "orange", "yellow"),  name = "",
                    label  = c("Scenario1: \n7.25% compound return", "Scenario2: \n6.9% compound return", "Scenario3: \n6.36% compound return",
                                "Scenario4: \n6.7% compound return", "Scenario5: \n6.5% compound return")) +
  labs(title = "Probability of funded ratio below 40% \nat any time prior to and including the given year  \n under different return scenarios", x = NULL, y = "Probability(%)") +
  theme(axis.text.x = element_text(size = 7), legend.position="bottom") +
  guides(color = guide_legend(keywidth = 3, keyheight = 1)) 

g1

g1.1 <- tbl.compareRS_FR40rolling %>% 
  ggplot(aes(x = year, y = FR40less, color = factor(RS, levels = paste0("RS", 1:5)))) + theme_bw() + 
  geom_line() + geom_point() + facet_grid(. ~ policy) + 
  scale_x_continuous(breaks = seq(2015, 2045, 5)) + 
  scale_color_manual(values = c("red","green", "blue2", "orange", "yellow"),  name = "",   #"Return \nScenarios",
                     label  = c("Scenario1: \n7.25% compound return", "Scenario2: \n6.9% compound return", "Scenario3: \n6.36% compound return",
                                "Scenario4: \n6.7% compound return", "Scenario5: \n6.5% compound return")) +
  labs(title = "Probability of funded ratio below 40% \nat any time prior to and including the given year \nunder different return scenarios", x = NULL, y = "Probability (%)") +
  theme(axis.text.x = element_text(size = 7), legend.position="bottom") +
  guides(color = guide_legend(keywidth = 3, keyheight = 1))



# Prob of high ERC
g2 <- tbl.compareRS_highERC %>% 
  ggplot(aes(x = year, y = ERC_PR30, color = factor(RS, levels = paste0("RS", 1:5)))) + theme_bw() + 
  geom_line() + geom_point() + facet_grid(. ~ policy) +
  scale_x_continuous(breaks = seq(2015, 2045, 5)) + 
  scale_color_manual(values = c("red","green", "blue2", "orange", "yellow"),  name = "",
                     label  = c("Scenario1: \n7.25% compound return", "Scenario2: \n6.9% compound return", "Scenario3: \n6.36% compound return",
                                "Scenario4: \n6.7% compound return", "Scenario5: \n6.5% compound return")) +
  labs(title = "Probability of ERC above 30% of payroll \nat any time prior to and including the given year  \n under different return scenarios", x = NULL, y = "Probability(%)") +
  theme(axis.text.x = element_text(size = 7), legend.position="bottom") +
  guides(color = guide_legend(keywidth = 3, keyheight = 1)) 
g2


# Prob of sharp ERC increases
g3 <- tbl.compareRS_ERCincrease %>% 
  ggplot(aes(x = year, y = Chg10Pts5y2, color = factor(RS, levels = paste0("RS", 1:5)))) + theme_bw() + 
  geom_line() + geom_point() + facet_grid(. ~ policy) +
  scale_x_continuous(breaks = seq(2015, 2045, 5)) + 
  scale_color_manual(values = c("red","green", "blue2", "orange", "yellow"),  name = "",
                     label  = c("Scenario1: \n7.25% compound return", "Scenario2: \n6.9% compound return", "Scenario3: \n6.36% compound return",
                                "Scenario4: \n6.7% compound return", "Scenario5: \n6.5% compound return")) +
  labs(title = "Probability of ERC rising by more than 10% of payroll \nat any time prior to and including the given year  \nunder different return scenarios", x = NULL, y = "Probability(%)") +
  theme(axis.text.x = element_text(size = 7), legend.position="bottom") +
  guides(color = guide_legend(keywidth = 3, keyheight = 1)) 
g3



ggsave(file = paste0(Outputs_folder, "CompareRS5.FR40.png"), g1, height = 5, width = 10)
ggsave(file = paste0(Outputs_folder, "CompareRS5.FR40.rolling.png"), g1.1, height = 5, width = 10)
ggsave(file = paste0(Outputs_folder, "CompareRS5.higERC.png"), g2, height = 5, width = 10)
ggsave(file = paste0(Outputs_folder, "CompareRS5.ERCIncrease.png"), g3, height = 5, width = 10)


# tables for comparing return scenarios. 




```


# Appendices
```{r}


g1 <- lresults_RS1.Cap$tbl.riskMeasure %>% 
  get_lineplot("year", "FR95more") + 
  coord_cartesian(ylim = c(0,100)) + 
  scale_y_continuous(breaks = seq(0,200, 10)) +
  labs(title = "Probability of funded ratio above 95% \nin a given year",
       x = NULL, y = "Probability (%)")
lresults_RS1.Cap$tbl.riskMeasure

g1

g2 <- lContVol_RS1.Cap$prob_FR95more.rolling %>% 
  get_lineplot("year", "FR95more") + 
  coord_cartesian(ylim = c(0,100)) + 
  scale_y_continuous(breaks = seq(0,200, 10)) +
  labs(title = "Probability of funded ratio above 95% \nat any time prior to and including the given year",
       x = NULL, y = "Probability (%)")
g1
g2


lContVol_RS1.Cap$prob_FR95more.rolling

ggsave(file = paste0(Outputs_folder, "FR95more.png"), g1, height = 7, width = 9)
ggsave(file = paste0(Outputs_folder, "FR95more.rolling.png"), g2, height = 7, width = 9)



```







 